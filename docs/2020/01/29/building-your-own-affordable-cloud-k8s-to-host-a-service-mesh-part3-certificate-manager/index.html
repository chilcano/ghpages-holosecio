<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Building your own affordable K8s to host a Service Mesh - Part 3: Certificate Manager | Holistic Security</title>
  <meta name="description" content="Hugo is a general-purpose website framework. Technically speaking, Hugo is a static site generator. Unlike systems that dynamically build a page with each visitor request, Hugo builds pages when you create or update your content. Since websites are viewed far more often than they are edited, Hugo is designed to provide an optimal viewing experience for your websiteâ€™s end users and an ideal writing experience for website authors.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Building your own affordable K8s to host a Service Mesh - Part 3: Certificate Manager" />
<meta property="og:description" content="In this blog post I&rsquo;ll explain how to get a X.509 TLS Certificate from Let&rsquo;s Encrypt{:target=&quot;_blank&quot;} automatically during the Terraform provision time, in this way we can now invoke the services additionally on port 443 (HTTPS/TLS).
During the Terraform execution, immediately after Kubernetes Cluster creation, the JetStack Cert-Manager{:target=&quot;_blank&quot;} is deployed in a Pod, it is who will request to Let&rsquo;s Encrypt{:target=&quot;_blank&quot;} service a X.509 TLS Certificate, once completed, the JetStack Cert-Manager{:target=&quot;_blank&quot;} will inject the X.509 Certificate as a Kubernetes Secret into NGINX Ingress Controller to enbale TLS.
At this point you must have created a Kubernetes Cluster with ExternalDNS and NGINX as Ingress Controller. If you don&rsquo;t know how to achieve that, I recommend to follow these posts:

Part 1 - Building your own affordable K8s to host a Service Mesh{:target=&quot;_blank&quot;}.
Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress{:target=&quot;_blank&quot;}.

{:target=&quot;_blank&quot;}" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chilcano.github.io/ghpages-holosecio/2020/01/29/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part3-certificate-manager/" />
<meta property="article:published_time" content="2020-01-29T10:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-29T10:00:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building your own affordable K8s to host a Service Mesh - Part 3: Certificate Manager"/>
<meta name="twitter:description" content="In this blog post I&rsquo;ll explain how to get a X.509 TLS Certificate from Let&rsquo;s Encrypt{:target=&quot;_blank&quot;} automatically during the Terraform provision time, in this way we can now invoke the services additionally on port 443 (HTTPS/TLS).
During the Terraform execution, immediately after Kubernetes Cluster creation, the JetStack Cert-Manager{:target=&quot;_blank&quot;} is deployed in a Pod, it is who will request to Let&rsquo;s Encrypt{:target=&quot;_blank&quot;} service a X.509 TLS Certificate, once completed, the JetStack Cert-Manager{:target=&quot;_blank&quot;} will inject the X.509 Certificate as a Kubernetes Secret into NGINX Ingress Controller to enbale TLS.
At this point you must have created a Kubernetes Cluster with ExternalDNS and NGINX as Ingress Controller. If you don&rsquo;t know how to achieve that, I recommend to follow these posts:

Part 1 - Building your own affordable K8s to host a Service Mesh{:target=&quot;_blank&quot;}.
Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress{:target=&quot;_blank&quot;}.

{:target=&quot;_blank&quot;}"/>

  
  
    
  
  
  <link rel="stylesheet" href="https://chilcano.github.io/ghpages-holosecio/css/style-light.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://chilcano.github.io/ghpages-holosecio/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://chilcano.github.io/ghpages-holosecio/">
  
    <div id="logo" style="background-image: url(https://chilcano.github.io/ghpages-holosecio/images/logo.png)"></div>
  
  <div id="title">
    <h1>Holistic Security</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
      
        <li><a href="/ghpages-holosecio/">Home</a></li>
      
        <li><a href="/ghpages-holosecio/post">Writings</a></li>
      
        <li><a href="/ghpages-holosecio/tags">Tags</a></li>
      
        <li><a href="/ghpages-holosecio/about">About</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <p>In this blog post I&rsquo;ll explain how to get a X.509 TLS Certificate from <a href="https://letsencrypt.org">Let&rsquo;s Encrypt</a>{:target=&quot;_blank&quot;} automatically during the Terraform provision time, in this way we can now invoke the services additionally on port 443 (HTTPS/TLS).<br>
During the Terraform execution, immediately after Kubernetes Cluster creation, the <a href="https://github.com/jetstack/cert-manager">JetStack Cert-Manager</a>{:target=&quot;_blank&quot;} is deployed in a Pod, it is who will request to <a href="https://letsencrypt.org">Let&rsquo;s Encrypt</a>{:target=&quot;_blank&quot;} service a X.509 TLS Certificate, once completed, the <a href="https://github.com/jetstack/cert-manager">JetStack Cert-Manager</a>{:target=&quot;_blank&quot;} will inject the X.509 Certificate as a Kubernetes Secret into NGINX Ingress Controller to enbale TLS.</p>
<p>At this point you must have created a Kubernetes Cluster with ExternalDNS and NGINX as Ingress Controller. If you don&rsquo;t know how to achieve that, I recommend to follow these posts:</p>
<ul>
<li><a href="http://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane">Part 1 - Building your own affordable K8s to host a Service Mesh</a>{:target=&quot;_blank&quot;}.</li>
<li><a href="http://holisticsecurity.io/2020/01/22/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part2-external-dns-ingress">Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress</a>{:target=&quot;_blank&quot;}.</li>
</ul>
<p><a href="/assets/img/20200129-affordablek8s-aws-01-arch-ingress-dns-tls-cert-manager.png"><img src="/assets/img/20200129-affordablek8s-aws-01-arch-ingress-dns-tls-cert-manager.png" alt="K8s Cluster created using AWS Spot Instances - Cert-Manager and Let&rsquo;s Encrypt" title="K8s Cluster created using AWS Spot Instances - Cert-Manager and Let's Encrypt"></a>{:target=&quot;_blank&quot;}</p>
<h2 id="steps">Steps</h2>
<h3 id="1-cleaning-everything">1. Cleaning everything</h3>
<p>If you are using the Terraform scripts to create an affordable K8s Cluster I&rsquo;ve forked and updated for you, then first of all you should clean up to start creating a new fresh K8s Cluster for following this scenario.</p>
<blockquote>
<p>If you want a cheap K8s Infrastructure on AWS, I recommend to use this GitHub repo I&rsquo;ve updated for you:
<a href="https://github.com/chilcano/kubeadm-aws/tree/0.2.1-chilcano">https://github.com/chilcano/kubeadm-aws/tree/0.2.1-chilcano</a></p>
</blockquote>
<p>Removing existing K8s Cluster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ terraform destroy <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var cluster-name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cheapk8s&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var k8s-ssh-key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ssh-key-for-us-east-1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var admin-cidr-blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.50.13.174/32&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var region<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;us-east-1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var kubernetes-version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.14.3&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var external-dns-enabled<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var nginx-ingress-enabled<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var nginx-ingress-domain<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ingress-nginx.cloud.holisticsecurity.io&#34;</span> 
</code></pre></div><p>If you have destroyed the K8s Cluster with <code>terraform destroy</code>, likely you have to remove unwanted records (created for your services) in the AWS Hosted Zone.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ export MY_SUBDOMAIN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cloud.holisticsecurity.io&#34;</span>
$ export HZ_ID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws route53 list-hosted-zones-by-name --dns-name <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>MY_SUBDOMAIN<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span> | jq -r <span style="color:#e6db74">&#39;.HostedZones[0].Id&#39;</span><span style="color:#66d9ef">)</span>
$ aws route53 list-resource-record-sets --hosted-zone-id $HZ_ID --query <span style="color:#e6db74">&#34;ResourceRecordSets[?Name != &#39;</span><span style="color:#e6db74">${</span>MY_SUBDOMAIN<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#39;]&#34;</span> | jq -c <span style="color:#e6db74">&#39;.[]&#39;</span> |
  <span style="color:#66d9ef">while</span> read -r RRS; <span style="color:#66d9ef">do</span>
    read -r name type <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#66d9ef">$(</span>jq -jr <span style="color:#e6db74">&#39;.Name, &#34; &#34;, .Type&#39;</span> <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#e6db74">&#34;</span>$RRS<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span> 
    CHG_ID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws route53 change-resource-record-sets --hosted-zone-id $HZ_ID --change-batch <span style="color:#e6db74">&#39;{&#34;Changes&#34;:[{&#34;Action&#34;:&#34;DELETE&#34;,&#34;ResourceRecordSet&#34;: &#39;</span><span style="color:#e6db74">&#34;</span>$RRS<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39; }]}&#39;</span> --output text --query <span style="color:#e6db74">&#39;ChangeInfo.Id&#39;</span><span style="color:#66d9ef">)</span>
    echo <span style="color:#e6db74">&#34; - DELETING: </span>$type<span style="color:#e6db74"> </span>$name<span style="color:#e6db74"> - CHANGE ID: </span>$CHG_ID<span style="color:#e6db74">&#34;</span>    
  <span style="color:#66d9ef">done</span>
</code></pre></div><p>For further details and an explanation about above step review this post:</p>
<ul>
<li><a href="http://holisticsecurity.io/2020/01/22/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part2-external-dns-ingress">Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress</a>{:target=&quot;_blank&quot;}.</li>
</ul>
<h3 id="2-create-a-fresh-k8s-cluster-with-jetstack-cert-manager-installed">2. Create a fresh K8s Cluster with JetStack Cert-Manager installed</h3>
<p>Note the <code>cert-manager-enabled=&quot;1&quot;</code> and <code>cert-manager-email=&quot;cheapk8s@holisticsecurity.io&quot;</code> parameters which are required to create a Kubernetes Cluster with the <a href="https://github.com/jetstack/cert-manager">JetStack Cert-Manager</a>{:target=&quot;_blank&quot;} installed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ terraform plan <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var cluster-name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cheapk8s&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var k8s-ssh-key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ssh-key-for-us-east-1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var admin-cidr-blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.50.13.174/32&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var region<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;us-east-1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var kubernetes-version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.14.3&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var external-dns-enabled<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var nginx-ingress-enabled<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var nginx-ingress-domain<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ingress-nginx.cloud.holisticsecurity.io&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var cert-manager-enabled<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var cert-manager-email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cheapk8s@holisticsecurity.io&#34;</span> 

$ terraform apply <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var cluster-name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cheapk8s&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var k8s-ssh-key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ssh-key-for-us-east-1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var admin-cidr-blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.50.13.174/32&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var region<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;us-east-1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var kubernetes-version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.14.3&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var external-dns-enabled<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var nginx-ingress-enabled<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var nginx-ingress-domain<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ingress-nginx.cloud.holisticsecurity.io&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var cert-manager-enabled<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var cert-manager-email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cheapk8s@holisticsecurity.io&#34;</span> 
</code></pre></div><h3 id="3-checking-recently-created-k8s-cluster-and-jetstack-cert-manager">3. Checking recently created K8s Cluster and JetStack Cert-Manager</h3>
<p><strong>1. Exploring the JetStack Cert-Manager resources created in the K8s Cluster</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># Get SSH access to K8s master node</span>
$ ssh ubuntu@<span style="color:#66d9ef">$(</span>terraform output master_dns<span style="color:#66d9ef">)</span> -i ~/Downloads/ssh-key-for-us-east-1.pem

<span style="color:#75715e"># List all namespaces</span>
$ kubectl get ns
NAME              STATUS   AGE
cert-manager      Active   159m
default           Active   161m
ingress-nginx     Active   158m
kube-node-lease   Active   161m
kube-public       Active   161m
kube-system       Active   161m

<span style="color:#75715e"># Listing all resources under namespace &#39;cert-manager&#39;</span>
$ kubectl get all -n cert-manager
NAME                                READY   STATUS    RESTARTS   AGE
pod/cert-manager-54d94bb6fc-9zchz   1/1     Running   <span style="color:#ae81ff">0</span>          5h22m

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cert-manager   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           5h22m

NAME                                      DESIRED   CURRENT   READY   AGE
replicaset.apps/cert-manager-54d94bb6fc   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>       5h22m
</code></pre></div><p><strong>2. Calling Ingress' <code>health check</code> over TLS.</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ curl https://ingress-nginx.cloud.holisticsecurity.io/healthz -v -k
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
&lt; HTTP/2 <span style="color:#ae81ff">200</span> 
&lt; server: nginx/1.15.5
&lt; date: Tue, <span style="color:#ae81ff">28</span> Jan <span style="color:#ae81ff">2020</span> 15:23:26 GMT
&lt; content-type: text/html
&lt; content-length: <span style="color:#ae81ff">0</span>
&lt; 
* Connection <span style="color:#75715e">#0 to host ingress-nginx.cloud.holisticsecurity.io left intact</span>
</code></pre></div><p><strong>3. Getting the TLS Certificate using <code>openssl</code></strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ echo | openssl s_client -showcerts -servername ingress-nginx.cloud.holisticsecurity.io -connect ingress-nginx.cloud.holisticsecurity.io:443 2&gt;/dev/null | openssl x509 -inform pem -noout -text
</code></pre></div><h3 id="4-calling-a-microservice-over-https-port-443">4. Calling a Microservice over HTTPS (port 443)</h3>
<p>Since all Microservices and RESTful API were configured to be invoked over 80/HTTP and 443/HTTPS and routed through the NGINX Ingress Controller. The only thing to do is call them through their FQDN (Fully Qualified Domain Name) and the Microservices' FQDN could be <code>https://ingress-nginx.cloud.holisticsecurity.io/&lt;MICROSERVICE_NAME&gt;</code>.</p>
<p>Then, let&rsquo;s try it using the <code>Hello Microservice</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># Get SSH access to K8s master node</span>
$ ssh ubuntu@<span style="color:#66d9ef">$(</span>terraform output master_dns<span style="color:#66d9ef">)</span> -i ~/Downloads/ssh-key-for-us-east-1.pem
   
<span style="color:#75715e"># Deploy Hello microservices, services and ingress</span>
$ kubectl apply -f https://raw.githubusercontent.com/chilcano/kubeadm-aws/0.2.1-chilcano/examples/hello-cheapk8s-app.yaml
$ kubectl apply -f https://raw.githubusercontent.com/chilcano/kubeadm-aws/0.2.1-chilcano/examples/hello-cheapk8s-svc.yaml
$ kubectl apply -f https://raw.githubusercontent.com/chilcano/kubeadm-aws/0.2.1-chilcano/examples/hello-cheapk8s-ingress.yaml
$ kubectl apply -f https://raw.githubusercontent.com/chilcano/kubeadm-aws/0.2.1-chilcano/examples/hello-cheapk8s-ingress-tls.yaml
   
<span style="color:#75715e"># Get status</span>
$ kubectl get pod,svc,ingress -n hello -o wide
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
NAME                                       HOSTS                                     ADDRESS   PORTS     AGE
ingress.extensions/hello-ingress-cip       ingress-nginx.cloud.holisticsecurity.io             <span style="color:#ae81ff">80</span>        16m
ingress.extensions/hello-ingress-cip-tls   ingress-nginx.cloud.holisticsecurity.io             80, <span style="color:#ae81ff">443</span>   15s
ingress.extensions/hello-ingress-np        hello-svc-np.cloud.holisticsecurity.io              <span style="color:#ae81ff">80</span>        16m
ingress.extensions/hello-ingress-np-tls    hello-svc-np.cloud.holisticsecurity.io              80, <span style="color:#ae81ff">443</span>   15s
</code></pre></div><p>Now, from any computer in Internet execute this command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># Calling Hello Microservices over HTTP</span>
$ curl http://ingress-nginx.cloud.holisticsecurity.io/hello
$ curl http://hello-svc-np.cloud.holisticsecurity.io/hello 

<span style="color:#75715e"># Calling Hello Microservices over HTTPS/TLS through `hello-ingress-cip-tls`</span>
$ curl https://ingress-nginx.cloud.holisticsecurity.io/hello -v -k
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
Hello version: v1, instance: hello-v1-66fc9c7d98-tljkw
* Connection <span style="color:#75715e">#0 to host ingress-nginx.cloud.holisticsecurity.io left intact</span>

<span style="color:#75715e"># Calling Hello Microservices over HTTPS/TLS through `hello-ingress-np-tls`</span>
$ curl https://hello-svc-np.cloud.holisticsecurity.io/hello -v -k
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
Hello version: v2, instance: hello-v2-845749f774-tft56
* Connection <span style="color:#75715e">#0 to host hello-svc-np.cloud.holisticsecurity.io left intact</span>

</code></pre></div><h2 id="conclusions">Conclusions</h2>
<ol>
<li>NGINX Ingress Controller routes HTTP and HTTPS/TLS traffic to Hello Microservices.</li>
<li>NGINX Ingress Controller manages TLS Termination, that means that Hello Microservices don&rsquo;t require X.509 TLS Certificate. In other words, the NGINX Ingress Controller redirect the ingress traffic to downstream microservice over HTTP standard.</li>
<li>Hello Microservices are exposed through NGINX Ingress enabling TLS and requesting X.509 TLS Certificate. Note the <code>annotations</code> used in the <code>Ingress Resource</code> definition. Below details:</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">hello-ingress-cip-tls</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
    <span style="color:#f92672">certmanager.k8s.io/issuer</span>: <span style="color:#e6db74">&#34;letsencrypt-prod&#34;</span>
    <span style="color:#f92672">certmanager.k8s.io/acme-challenge-type</span>: <span style="color:#ae81ff">http01</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">hello</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">tls</span>:
  - <span style="color:#f92672">hosts</span>:
    - <span style="color:#ae81ff">ingress-nginx.cloud.holisticsecurity.io</span>
    <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">ingress-nginx-cloud-holisticsecurity-io-https</span>
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">ingress-nginx.cloud.holisticsecurity.io</span>
    <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
        <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">hello-svc-cip</span>
          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">5080</span>
---
</code></pre></div><p>In the next post I&rsquo;ll explain how to enable Mutual TLS Authentication for Microservices.
Stay tuned.</p>
<h2 id="references">References</h2>
<ol>
<li><a href="https://github.com/jetstack/cert-manager">JetStack Cert Manager - x.509 Certs for Kubernetes</a>{:target=&quot;_blank&quot;}</li>
<li><a href="http://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane">Part 1 - Building your own affordable K8s to host a Service Mesh</a>{:target=&quot;_blank&quot;}.</li>
<li><a href="http://holisticsecurity.io/2020/01/22/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-part2-external-dns-ingress">Part 2 - Building your own affordable K8s - ExternalDNS and NGINX as Ingress</a>{:target=&quot;_blank&quot;}.</li>
</ol>
  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  Holistic Security 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/ghpages-holosecio/">Home</a></li>
         
        <li><a href="/ghpages-holosecio/post">Writings</a></li>
         
        <li><a href="/ghpages-holosecio/tags">Tags</a></li>
         
        <li><a href="/ghpages-holosecio/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/ghpages-holosecio/lib/font-awesome/css/all.min.css>
<script src=/ghpages-holosecio/lib/jquery/jquery.min.js></script>
<script src=/ghpages-holosecio/js/main.js></script>
</html>
