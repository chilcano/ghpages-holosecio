<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Building your own affordable K8s to host a Service Mesh - Part 1 | Holistic Security</title>
  <meta name="description" content="With The Systems Thinking Methodology we are able to see any problem in a complete and holistic manner, in fact, The Systems Thinking Methodology allows us to solve complex problems (IT Security, Global Warming, World Poverty, etc.) by considering new factors, elements and variables (usability, trust, quality, risk, etc.) which were not considered initially.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Building your own affordable K8s to host a Service Mesh - Part 1" />
<meta property="og:description" content="I want to build a Container-based Cloud to deploy any kind of workload (RESTful API, Microservices, Event-Driven, Functions, etc.) but it should be affordable, ready to use, reliable, secure and productionable. This means:

Productionable: should be fully functional and ready to be used as a production environment.
Reliable and Secure: able to improve the security level by implementing more security controls, at least fully isolated secure private networking.
Affordable: cheaper.
Ready to use: able to be automated (DevOps and IaC) with a mature management API.

Below a high level architecture of Container-based Cloud I want to get. I will focus on the Service Mesh Data Plane.

These requeriments restric some options, all of them using any Public Cloud Provider, but considering the AWS Spot Instances and Google Cloud Preemptible VM Instances. Unfortunately Microsoft Azure only provides Low-Priority VMs to be used from Azure Batch Service. But if you are new user, you could apply for using the Free Tier in all of 3 Cloud Providers." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://holisticsecurity.io/2020/01/16/building-your-own-affordable-cloud-k8s-to-host-a-service-mesh-data-plane/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-01-16T10:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-16T10:00:00+00:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building your own affordable K8s to host a Service Mesh - Part 1"/>
<meta name="twitter:description" content="I want to build a Container-based Cloud to deploy any kind of workload (RESTful API, Microservices, Event-Driven, Functions, etc.) but it should be affordable, ready to use, reliable, secure and productionable. This means:

Productionable: should be fully functional and ready to be used as a production environment.
Reliable and Secure: able to improve the security level by implementing more security controls, at least fully isolated secure private networking.
Affordable: cheaper.
Ready to use: able to be automated (DevOps and IaC) with a mature management API.

Below a high level architecture of Container-based Cloud I want to get. I will focus on the Service Mesh Data Plane.

These requeriments restric some options, all of them using any Public Cloud Provider, but considering the AWS Spot Instances and Google Cloud Preemptible VM Instances. Unfortunately Microsoft Azure only provides Low-Priority VMs to be used from Azure Batch Service. But if you are new user, you could apply for using the Free Tier in all of 3 Cloud Providers."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://holisticsecurity.io/css/style-white.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://holisticsecurity.io/images/favicon.ico" />

  
  
  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-156433649-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
  
  

  <link rel="stylesheet" href="https://holisticsecurity.io/css/custom-cactus-style-white.css">
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://holisticsecurity.io/">
  
    <div id="logo" style="background-image: url(https://holisticsecurity.io/images/logo.png)"></div>
  
  <div id="title">
    <h1>Holistic Security</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/post">Blog</a></li>
      
        <li><a href="/taxonomy">Taxonomy</a></li>
      
        <li><a href="/about">About</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  
  <h1 class="posttitle" itemprop="name headline"> Building your own affordable K8s to host a Service Mesh - Part 1 </h1>

  <ul class="post-list">  
      <li class="post-item">
        <div class="meta">
          <time datetime="2020-01-16 10:00:00 &#43;0000 UTC" itemprop="datePublished">2020-01-16</time>
        </div>
        <span>    
          
          
          <div class="article-category">
              
              
              <a class="category-link" href="/categories/cloud">Cloud</a>
              
               · 
              <a class="category-link" href="/categories/service-mesh">Service Mesh</a>
              
              · 
          </div>
          
          
          <div class="article-tag">
              
              
              <a class="tag-link" href="/tags/aws" rel="tag">AWS</a>
              
               · 
              <a class="tag-link" href="/tags/data-plane" rel="tag">Data Plane</a>
              
               · 
              <a class="tag-link" href="/tags/microservice" rel="tag">Microservice</a>
              
          </div>
          
  
        </span>
      </li>  
    </ul>

  <div class="content" itemprop="articleBody">
  
    <p>I want to build a Container-based Cloud to deploy any kind of workload (RESTful API, Microservices, Event-Driven, Functions, etc.) but it should be affordable, ready to use, reliable, secure and productionable. This means:</p>
<ul>
<li>Productionable: should be fully functional and ready to be used as a production environment.</li>
<li>Reliable and Secure: able to improve the security level by implementing more security controls, at least fully isolated secure private networking.</li>
<li>Affordable: cheaper.</li>
<li>Ready to use: able to be automated (DevOps and IaC) with a mature management API.</li>
</ul>
<p>Below a high level architecture of Container-based Cloud I want to get. I will focus on the Service Mesh Data Plane.<br>
<a href="/assets/img/20200116-service-mesh-01-reference-arch-2.png"><img src="/assets/img/20200116-service-mesh-01-reference-arch-2.png" alt="" title="Service Mesh hosted in a Container-based Cloud"></a></p>
<p>These requeriments restric some options, all of them using any Public Cloud Provider, but considering the <a href="https://aws.amazon.com/ec2/spot">AWS Spot Instances</a> and <a href="https://cloud.google.com/preemptible-vms">Google Cloud Preemptible VM Instances</a>. Unfortunately Microsoft Azure only provides Low-Priority VMs to be used from Azure Batch Service. But if you are new user, you could apply for using the Free Tier in all of 3 Cloud Providers.</p>
<p>For further information, you can read these articles:</p>
<ul>
<li><a href="https://spotinst.com/blog/amazon-ec2-spot-vs-azure-lpvms-vs-google-pvms-vs-ibm-transient-servers/">Understanding Excess Cloud Capacity: Amazon EC2 Spot vs. Azure Low-Priority VM vs. Google Preemptible VM vs IBM Transient Servers</a> - By Zev Schonberg, 2019-Mar</li>
<li><a href="https://www.computerworld.com/article/3427685/cloud-vendor-free-tiers-compared--aws-vs-azure-vs-google-cloud-platform.html">Cloud vendor free tiers compared: AWS vs Azure vs Google Cloud Platform</a> - By Scott Carey, 2018-May</li>
</ul>
<p>The automation can be achieved using Terraform, Python, Bash, etc. and the 2 Cloud Providers (AWS and Google Cloud) choosen for this project have a mature Management API which can be used to automatization and configuration.</p>
<h2 id="how-much-will-the-kubernetes-cluster-cost-me">How much will the Kubernetes Cluster cost me?</h2>
<p>Well, It is too difficult to know the cost exactly right now, however, I can estimate what it will cost me for a month. Below you can see two images, the first one is the High level AWS design and the next one is the approximate cost of the all AWS resources used during a month.</p>
<p><a href="/assets/img/20200122-service-mesh-01-affordablek8s-aws-arch.png"><img src="/assets/img/20200122-service-mesh-01-affordablek8s-aws-arch.png" alt="" title="Kubernetes Cluster using AWS Spot Instances"></a></p>
<p>You can see below that my K8s Cluster using AWS Spot instances will cost approx. <code>6.79 Euros</code>, that includes:</p>
<ul>
<li>Instances EC2 Spot: 2</li>
<li>Type: m1.small</li>
<li>AZ: us-east-1</li>
<li>S3 Storage 1GB</li>
<li>S3 Put/Copy/Post / mo(K): 96</li>
<li>S3 Get and other / mo(K): 2880</li>
<li>Backup into S3 cron expression: &ldquo;*/15 * * * *&rdquo;</li>
</ul>
<p><a href="/assets/img/20200116-service-mesh-04-affordable-k8s-aws-budget.png"><img src="/assets/img/20200116-service-mesh-04-affordable-k8s-aws-budget.png" alt="" title="K8s Cluster hosted using AWS Spot Instances - Cost"></a></p>
<h2 id="what-about-digital-ocean-hetzner-cloud-scaleway-and-other-providers">What about Digital Ocean, Hetzner Cloud, Scaleway and other Providers?</h2>
<p>Yes, all of them are worthy of being considered too and will do it in next blog posts, but let&rsquo;s start with AWS and Google first.
Ah, if you don&rsquo;t want to wait, I suggest you read the <a href="https://github.com/hobby-kube/guide">Kubernetes clusters for the hobbyist</a> guide written by Patrick Stadler. This guide explains how to build a Kubernetes Cluster on <a href="https://www.digitalocean.com">Digital Ocean</a>, <a href="https://www.hetzner.com/">Hetzner Cloud</a> and/or <a href="https://www.scaleway.com">Scaleway</a>, and this guide is accompanied by a fully automated cluster setup based on Terraform recipes. The guide suggests that <a href="https://www.linode.com/">Linode</a>, <a href="https://www.vultr.com">Vultr</a> are other viable options.</p>
<blockquote>
<p>If you know a reliable, secure and affordable Cloud Provider, don&rsquo;t hesitate to drop me a line.</p>
</blockquote>
<h2 id="cheap-doesnt-mean-unreliable-doesnt-mean-unsecure">Cheap doesn&rsquo;t mean unreliable, doesn&rsquo;t mean unsecure</h2>
<p>Choose a cloud provider based on a few criteria such as trustworthiness, reliability, pricing and data center location is critical for this project. Security is a must, create a cluster in a private network doesn&rsquo;t mean it is secure. I will create multiple clusters to host different kind of workloads, then they should be isolated, implement secure private networking and implement Access Control (Authentication and Authorization).</p>
<h2 id="lets-do-it">Let&rsquo;s do it</h2>
<p>Then, in this post I will explain how to create an affordable Data Plane in AWS, to do that I&rsquo;m going to use the <a href="https://github.com/cablespaghetti/kubeadm-aws">Really cheap Kubernetes cluster on AWS with kubeadm</a> Guide&rsquo;s <a href="https://cablespaghetti.github.io">Sam Weston</a> which will create a Kubernetes Cluster in AWS by using <a href="https://aws.amazon.com/ec2/spot">AWS EC2 Spot Instances</a>, <a href="https://www.terraform.io">Terraform</a>, Bash and <a href="https://helm.sh">Helm</a> for automation, External DNS and Nginx Ingress as a cheap ELB alternative, and <a href="https://cert-manager.io">Cert Manager</a> for TLS certificates via <a href="https://letsencrypt.org">Let&rsquo;s Encrypt</a>. Other features implemented are:</p>
<ul>
<li>Automatic backup and recovery.</li>
<li>Auto Scaling of worker nodes.</li>
<li>Persistent Volumes using General Purpose SSD (GP2) storage on <a href="https://aws.amazon.com/ebs">AWS EBS</a>.</li>
</ul>
<h3 id="steps">Steps</h3>
<h4 id="1-terraform">1) Terraform</h4>
<h5 id="1-download-terraform-bundle">1. Download Terraform bundle.</h5>
<p>I&rsquo;ve attempted to use Terraform 12.x, but unfortunately Terraform scrips need to be tweaked before, for that, for this blog post I recommend download and install <a href="https://releases.hashicorp.com/terraform/">Terraform 11.15-oci</a> version.<br>
The <code>oci</code> suffix means that Terraform is compatible with <a href="https://www.terraform.io/docs/providers/oci/guides/faq.html">Oracle Cloud Infrastructure</a>.</p>
<h5 id="2-extract-the-downloaded-terraform-binary-file-and-move-it-into-a-directory-searched-for-executables">2. Extract the downloaded <code>terraform</code> binary file and move it into a directory searched for executables.</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~$ unzip ~/Downloads/terraform_0.11.15-oci_linux_amd64.zip 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~$ sudo mv terraform /usr/local/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~$ terraform -v
</span></span><span style="display:flex;"><span>Terraform v0.11.15-oci
</span></span></code></pre></div><h4 id="2-aws-optional">2) AWS (optional)</h4>
<p>Although AWS CLI isn&rsquo;t needed for the purpose of running Terraform, that will be useful in the next blog posts.</p>
<ol>
<li>Install AWS CLI. It requires Pip 3.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~$ pip3 --version
</span></span><span style="display:flex;"><span>pip 18.1 from /usr/lib/python3/dist-packages/pip <span style="color:#f92672">(</span>python 3.7<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~$ pip3 install awscli --upgrade --user
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~$ aws --version
</span></span><span style="display:flex;"><span>aws-cli/1.16.314 Python/3.7.5 Linux/5.3.0-26-generic botocore/1.13.50
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~$ which aws
</span></span><span style="display:flex;"><span>/home/chilcano/.local/bin/aws
</span></span></code></pre></div><ol start="2">
<li>Configure the AWS account.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~$ aws configure --profile affordablek8s01
</span></span><span style="display:flex;"><span>AWS Access Key ID <span style="color:#f92672">[</span>None<span style="color:#f92672">]</span>: &lt;ACCESS-KEY-ID&gt;
</span></span><span style="display:flex;"><span>AWS Secret Access Key <span style="color:#f92672">[</span>None<span style="color:#f92672">]</span>: &lt;SECRET-ACCESS-KEY&gt;
</span></span><span style="display:flex;"><span>Default region name <span style="color:#f92672">[</span>None<span style="color:#f92672">]</span>: us-west-2
</span></span><span style="display:flex;"><span>Default output format <span style="color:#f92672">[</span>None<span style="color:#f92672">]</span>: json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~$ cat .aws/credentials 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>affordablek8s01<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>aws_access_key_id <span style="color:#f92672">=</span> &lt;ACCESS-KEY-ID&gt;
</span></span><span style="display:flex;"><span>aws_secret_access_key <span style="color:#f92672">=</span> &lt;SECRET-ACCESS-KEY&gt;
</span></span></code></pre></div><ol start="3">
<li>Create a SSH key under the AZ where the resources will be created. In my case I&rsquo;ll create in <code>us-east-1</code> (Virginia) from the <code>AWS Web Console &gt; NETWORK &amp; SECURITY &gt; Key Pairs</code>. This SSH key will be used to get access to all nodes created in AWS for that specific AZ.</li>
</ol>
<h4 id="3-create-the-kubernetes-cluster-in-aws-using-terraform">3) Create the Kubernetes Cluster in AWS using Terraform</h4>
<ol>
<li>Clone the Github repo.</li>
</ol>
<p>You can clone the <a href="https://github.com/chilcano/kubeadm-aws">forked GitHub repo</a> and switch to <code>0.2.1-chilcano</code> branch.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos$ git clone https://github.com/chilcano/kubeadm-aws affordable-k8s-tf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Cloning into <span style="color:#e6db74">&#39;affordable-k8s-tf&#39;</span>...
</span></span><span style="display:flex;"><span>remote: Enumerating objects: 327, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>remote: Total <span style="color:#ae81ff">327</span> <span style="color:#f92672">(</span>delta 0<span style="color:#f92672">)</span>, reused <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>delta 0<span style="color:#f92672">)</span>, pack-reused <span style="color:#ae81ff">327</span>
</span></span><span style="display:flex;"><span>Receiving objects: 100% <span style="color:#f92672">(</span>327/327<span style="color:#f92672">)</span>, 71.68 KiB | 638.00 KiB/s, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>Resolving deltas: 100% <span style="color:#f92672">(</span>210/210<span style="color:#f92672">)</span>, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~/git-repos$ cd affordable-k8s-tf/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ git tag -l
</span></span><span style="display:flex;"><span>0.1.0
</span></span><span style="display:flex;"><span>0.1.1
</span></span><span style="display:flex;"><span>0.1.2
</span></span><span style="display:flex;"><span>0.2.0
</span></span><span style="display:flex;"><span>0.2.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ git branch -a
</span></span><span style="display:flex;"><span>* master
</span></span><span style="display:flex;"><span>   remotes/origin/0.2.1-chilcano
</span></span><span style="display:flex;"><span>   remotes/origin/HEAD -&gt; origin/master
</span></span><span style="display:flex;"><span>   remotes/origin/master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ git branch -r
</span></span><span style="display:flex;"><span>   origin/0.2.1-chilcano
</span></span><span style="display:flex;"><span>   origin/HEAD -&gt; origin/master
</span></span><span style="display:flex;"><span>   origin/master
</span></span></code></pre></div><p>Now, let&rsquo;s switch to <code>0.2.1-chilcano</code> branch.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ git checkout 0.2.1-chilcano
</span></span><span style="display:flex;"><span>Branch <span style="color:#e6db74">&#39;0.2.1-chilcano&#39;</span> set up to track remote branch <span style="color:#e6db74">&#39;0.2.1-chilcano&#39;</span> from <span style="color:#e6db74">&#39;origin&#39;</span>.
</span></span><span style="display:flex;"><span>Switched to a new branch <span style="color:#e6db74">&#39;0.2.1-chilcano&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ git status
</span></span><span style="display:flex;"><span>On branch 0.2.1-chilcano
</span></span><span style="display:flex;"><span>Your branch is up to date with <span style="color:#e6db74">&#39;origin/0.2.1-chilcano&#39;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nothing to commit, working tree clean
</span></span></code></pre></div><p>Alternatively to all above steps you can clone the <code>0.2.1-chilcano</code> branch only of GitHub repo as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos$ git clone --single-branch --branch 0.2.1-chilcano https://github.com/chilcano/kubeadm-aws affordable-k8s-tf
</span></span></code></pre></div><ol start="2">
<li>Update <code>variables.tf</code>.</li>
</ol>
<p>Hard-coding any credentials into any Terraform configuration is not recommended. I recommend to provide your AWS credentials via <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> environment variables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ export AWS_ACCESS_KEY_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;an-access-key&#34;</span>
</span></span><span style="display:flex;"><span>$ export AWS_SECRET_ACCESS_KEY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;a-secret-key&#34;</span>
</span></span></code></pre></div><p>In my case I&rsquo;m not going to update any variables in <code>variables.tf</code>, I will overwrite them when running <code>terraform apply</code>. But if you want to do, the variables you have to modify are:</p>
<ul>
<li><code>cluster-name = &quot;MY-CHEAP-K8S&quot;</code></li>
<li><code>access_key = &quot;ENV-VAR-VALUE-WILL-BE-READ&quot;</code></li>
<li><code>secret_key = &quot;ENV-VAR-VALUE-WILL-BE-READ&quot;</code></li>
<li><code>k8s-ssh-key = &quot;SSH-KEY-NAME-CREATED-IN-AWS-CONSOLE&quot;</code></li>
<li><code>admin-cidr-blocks = &quot;YOUR-PUBLIC-IP-ADDRESS/32&quot;</code></li>
<li><code>region = &quot;us-east-1&quot;</code></li>
<li><code>master-instance-type = &quot;m1.small&quot;</code></li>
<li><code>worker-instance-type = &quot;m1.small&quot;</code></li>
</ul>
<p>If you change the <code>master-instance-type</code> and <code>worker-instance-type</code> values to <code>t2.micro</code> for example, that isn&rsquo;t going to work because the <code>t2.micro</code> AMIs are prepared to be autoscaled.</p>
<ol start="3">
<li>Update <code>main.tf</code> and initialize the Terraform Providers.</li>
</ol>
<p>I will update <code>main.tf</code> to configure the 2 Terraform providers (<code>aws</code> and <code>random</code>) with proper versions according <code>Terraform v0.11.15-oci</code> version:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-terraform" data-lang="terraform"><span style="display:flex;"><span><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;aws&#34;</span> {<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   #version    = &#34;~&gt; 1.48&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">version</span>    = <span style="color:#e6db74">&#34;~&gt; 2.44.0&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">access_key</span> = <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">access_key</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">secret_key</span> = <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">secret_key</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">region</span>     = <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>var.<span style="color:#a6e22e">region</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;template&#34;</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">version</span>    = <span style="color:#e6db74">&#34;1.0.0&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;random&#34;</span> {<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   #version    = &#34;2.0.0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">version</span>    = <span style="color:#e6db74">&#34;2.1.0&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now, initialize Terraform.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ terraform init
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Initializing provider plugins...
</span></span><span style="display:flex;"><span>- Checking <span style="color:#66d9ef">for</span> available provider plugins on https://releases.hashicorp.com...
</span></span><span style="display:flex;"><span>- Downloading plugin <span style="color:#66d9ef">for</span> provider <span style="color:#e6db74">&#34;template&#34;</span> <span style="color:#f92672">(</span>1.0.0<span style="color:#f92672">)</span>...
</span></span><span style="display:flex;"><span>- Downloading plugin <span style="color:#66d9ef">for</span> provider <span style="color:#e6db74">&#34;random&#34;</span> <span style="color:#f92672">(</span>2.1.0<span style="color:#f92672">)</span>...
</span></span><span style="display:flex;"><span>- Downloading plugin <span style="color:#66d9ef">for</span> provider <span style="color:#e6db74">&#34;aws&#34;</span> <span style="color:#f92672">(</span>2.44.0<span style="color:#f92672">)</span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform has been successfully initialized!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You may now begin working with Terraform. Try running <span style="color:#e6db74">&#34;terraform plan&#34;</span> to see
</span></span><span style="display:flex;"><span>any changes that are required <span style="color:#66d9ef">for</span> your infrastructure. All Terraform commands
</span></span><span style="display:flex;"><span>should now work.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>If you ever set or change modules or backend configuration <span style="color:#66d9ef">for</span> Terraform,
</span></span><span style="display:flex;"><span>rerun this command to reinitialize your working directory. If you forget, other
</span></span><span style="display:flex;"><span>commands will detect it and remind you to <span style="color:#66d9ef">do</span> so <span style="color:#66d9ef">if</span> necessary.
</span></span></code></pre></div><ol start="4">
<li>Get the Terraform Plan.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ terraform plan <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var cluster-name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cheapk8s&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var k8s-ssh-key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ssh-key-for-us-east-1&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var admin-cidr-blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.46.128.76/32&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var region<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;us-east-1&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var kubernetes-version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.14.3&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ terraform -v
</span></span><span style="display:flex;"><span>Terraform v0.11.15-oci
</span></span><span style="display:flex;"><span>+ provider.aws v2.44.0
</span></span><span style="display:flex;"><span>+ provider.random v2.1.0
</span></span><span style="display:flex;"><span>+ provider.template v1.0.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Your version of Terraform is out of date! The latest version
</span></span><span style="display:flex;"><span>is 0.12.19. You can update by downloading from www.terraform.io/downloads.html
</span></span></code></pre></div><ol start="5">
<li>Visual exploration of the AWS resources are going to be created by Terraform.</li>
</ol>
<p>Terraform is able to export all Terraform scripts into a file in <a href="https://www.graphviz.org/doc/info/lang.html">DOT format</a>, useful to generate a graph through <a href="http://www.graphviz.org">GraphViz</a>. All details are explained here <a href="https://www.terraform.io/docs/commands/graph.html">&ldquo;Terraform - Command: graph&rdquo;</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ sudo apt install graphviz
</span></span><span style="display:flex;"><span>terraform graph | dot -Tsvg &gt; your-graph.svg
</span></span></code></pre></div><p>In my case I&rsquo;m going to tweaking the DOT file to get a better graph. In fact, you can do it and once done, using an online service like this <a href="https://dreampuf.github.io/GraphvizOnline">Graphviz Online</a> generate SVG file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ terraform graph -draw-cycles -module-depth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -type<span style="color:#f92672">=</span>apply &gt; 20200116-service-mesh-02-affordable-k8s-aws-graph.dot
</span></span></code></pre></div><p>You can download my updated DOT file from here <a href="/assets/img/20200116-service-mesh-02-affordable-k8s-aws-graph.dot">20200116-service-mesh-02-affordable-k8s-aws-graph.dot</a>.</p>
<p><a href="/assets/img/20200116-service-mesh-02-affordable-k8s-aws-graph.svg"><img src="/assets/img/20200116-service-mesh-02-affordable-k8s-aws-graph.svg" alt="Affordable K8s Data Plane hosted in AWS Graph" title="Affordable K8s Data Plane hosted in AWS Graph"></a></p>
<ol start="6">
<li>Apply the Terraform Plan.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ terraform apply <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var cluster-name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cheapk8s&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var k8s-ssh-key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ssh-key-for-us-east-1&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var admin-cidr-blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.46.128.76/32&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var region<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;us-east-1&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var kubernetes-version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.14.3&#34;</span>
</span></span></code></pre></div><p>And if you want to destroy all resources recently created by <code>terraform apply</code>, you can do it executing this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ terraform destroy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var cluster-name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cheapk8s&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var k8s-ssh-key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ssh-key-for-us-east-1&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var admin-cidr-blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.46.128.76/32&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var region<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;us-east-1&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -var kubernetes-version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.14.3&#34;</span>
</span></span></code></pre></div><h4 id="4-check-the-kubernetes-cluster">4) Check the Kubernetes Cluster</h4>
<p>If we want to check the Kubernetes Cluster creation, we have to review the <code>/var/log/cloud-init-output.log</code>. Before we should get remote access to Kubernetes Master host.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ chmod <span style="color:#ae81ff">400</span> ~/Downloads/ssh-key-for-us-east-1.pem
</span></span></code></pre></div><p>Now, getting remote access to Kubernetes Master host.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ ssh ubuntu@<span style="color:#66d9ef">$(</span>terraform output master_dns<span style="color:#66d9ef">)</span> -i ~/Downloads/ssh-key-for-us-east-1.pem -- cat /var/log/cloud-init-output.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Completed 1.0 KiB/1.0 KiB <span style="color:#f92672">(</span>6.9 KiB/s<span style="color:#f92672">)</span> with <span style="color:#ae81ff">1</span> file<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> remaining
</span></span><span style="display:flex;"><span>upload: etc/kubernetes/pki/ca.crt to s3://cheapk8s20200115152212812700000001/pki/i-9343ae2e5c0e52dec/ca.crt
</span></span><span style="display:flex;"><span>Completed 1.6 KiB/1.6 KiB <span style="color:#f92672">(</span>12.5 KiB/s<span style="color:#f92672">)</span> with <span style="color:#ae81ff">1</span> file<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> remaining
</span></span><span style="display:flex;"><span>upload: etc/kubernetes/pki/ca.key to s3://cheapk8s20200115152212812700000001/pki/i-9343ae2e5c0e52dec/ca.key
</span></span><span style="display:flex;"><span>Created symlink /etc/systemd/system/multi-user.target.wants/check-termination.service → /etc/systemd/system/check-termination.service.
</span></span><span style="display:flex;"><span>Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 running <span style="color:#e6db74">&#39;modules:final&#39;</span> at Wed, <span style="color:#ae81ff">15</span> Jan <span style="color:#ae81ff">2020</span> 15:24:48 +0000. Up 81.04 seconds.
</span></span><span style="display:flex;"><span>Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 finished at Wed, <span style="color:#ae81ff">15</span> Jan <span style="color:#ae81ff">2020</span> 15:33:22 +0000. Datasource DataSourceEc2Local.  Up 594.92 seconds
</span></span></code></pre></div><p>If you see above logs, that means that likely everything worked and Kubernetes Cluster was created successfully.
But, if you see below logs, that means Kubernetes Cluster wasn&rsquo;t created. In the below logs there are errors about Kubernetes packages (<code>kubeadm</code>, <code>kubelet</code> and <code>kubernetes-cni</code>) dependencies unmet when using <code>kubernetes-version=&quot;1.13.4&quot;</code> (default version of these Terraform scripts). To fix it we should change it to <code>kubernetes-version=&quot;1.14.3&quot;</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ubuntu@ip-10-0-100-4:~$ cat /var/log/cloud-init-output.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Some packages could not be installed. This may mean that you have
</span></span><span style="display:flex;"><span>requested an impossible situation or <span style="color:#66d9ef">if</span> you are using the unstable
</span></span><span style="display:flex;"><span>distribution that some required packages have not yet been created
</span></span><span style="display:flex;"><span>or been moved out of Incoming.
</span></span><span style="display:flex;"><span>The following information may help to resolve the situation:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The following packages have unmet dependencies:
</span></span><span style="display:flex;"><span> kubeadm : Depends: kubernetes-cni <span style="color:#f92672">(=</span> 0.6.0<span style="color:#f92672">)</span> but 0.7.5-00 is to be installed
</span></span><span style="display:flex;"><span> kubelet : Depends: kubernetes-cni <span style="color:#f92672">(=</span> 0.6.0<span style="color:#f92672">)</span> but 0.7.5-00 is to be installed
</span></span><span style="display:flex;"><span>E: Unable to correct problems, you have held broken packages.
</span></span><span style="display:flex;"><span>Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 running <span style="color:#e6db74">&#39;modules:final&#39;</span> at Wed, <span style="color:#ae81ff">15</span> Jan <span style="color:#ae81ff">2020</span> 11:15:47 +0000. Up 88.84 seconds.
</span></span><span style="display:flex;"><span>2020-01-15 11:16:17,468 - util.py<span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span>: Failed running /var/lib/cloud/instance/scripts/part-001 <span style="color:#f92672">[</span>100<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>2020-01-15 11:16:17,486 - cc_scripts_user.py<span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span>: Failed to run module scripts-user <span style="color:#f92672">(</span>scripts in /var/lib/cloud/instance/scripts<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-01-15 11:16:17,486 - util.py<span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span>: Running module scripts-user <span style="color:#f92672">(</span>&lt;module <span style="color:#e6db74">&#39;cloudinit.config.cc_scripts_user&#39;</span> from <span style="color:#e6db74">&#39;/usr/lib/python3/dist-packages/cloudinit/config/cc_scripts_user.py&#39;</span>&gt;<span style="color:#f92672">)</span> failed
</span></span><span style="display:flex;"><span>Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 finished at Wed, <span style="color:#ae81ff">15</span> Jan <span style="color:#ae81ff">2020</span> 11:16:18 +0000. Datasource DataSourceEc2Local.  Up 119.65 seconds
</span></span></code></pre></div><p>The below log shows other error related with incompatible <code>apiVersion</code> in <code>init-config.yaml</code> file created by <code>master.sh</code>.
It shoud be changed to <code>apiVersion: kubeadm.k8s.io/v1beta1</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ubuntu@ip-10-0-100-4:~$ cat /var/log/cloud-init-output.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Running kubeadm init&#34;</span>
</span></span><span style="display:flex;"><span>  kubeadm init --config<span style="color:#f92672">=</span>init-config.yaml --ignore-preflight-errors<span style="color:#f92672">=</span>NumCPU
</span></span><span style="display:flex;"><span>  touch /tmp/fresh-cluster
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>Running kubeadm init
</span></span><span style="display:flex;"><span>your configuration file uses a deprecated API spec: <span style="color:#e6db74">&#34;kubeadm.k8s.io/v1alpha3&#34;</span>. Please use <span style="color:#e6db74">&#39;kubeadm config migrate --old-config old.yaml --new-config new.yaml&#39;</span>, which will write the new, similar spec using a newer API version.
</span></span><span style="display:flex;"><span>Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 running <span style="color:#e6db74">&#39;modules:final&#39;</span> at Wed, <span style="color:#ae81ff">15</span> Jan <span style="color:#ae81ff">2020</span> 12:05:30 +0000. Up 78.18 seconds.
</span></span><span style="display:flex;"><span>2020-01-15 12:10:10,299 - util.py<span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span>: Failed running /var/lib/cloud/instance/scripts/part-001 <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>2020-01-15 12:10:10,308 - cc_scripts_user.py<span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span>: Failed to run module scripts-user <span style="color:#f92672">(</span>scripts in /var/lib/cloud/instance/scripts<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-01-15 12:10:10,308 - util.py<span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span>: Running module scripts-user <span style="color:#f92672">(</span>&lt;module <span style="color:#e6db74">&#39;cloudinit.config.cc_scripts_user&#39;</span> from <span style="color:#e6db74">&#39;/usr/lib/python3/dist-packages/cloudinit/config/cc_scripts_user.py&#39;</span>&gt;<span style="color:#f92672">)</span> failed
</span></span><span style="display:flex;"><span>Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~18.04.1 finished at Wed, <span style="color:#ae81ff">15</span> Jan <span style="color:#ae81ff">2020</span> 12:10:10 +0000. Datasource DataSourceEc2Local.  Up 357.91 seconds
</span></span></code></pre></div><h4 id="5-access-to-kubernetes-cluster">5) Access to Kubernetes Cluster</h4>
<p>If you want to know if your Kubernetes Cluster was created successfully, then you should do these checkings:</p>
<ol>
<li>Check that there are no errors in <code>/var/log/cloud-init-output.log</code> log file.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ ssh ubuntu@<span style="color:#66d9ef">$(</span>terraform output master_dns<span style="color:#66d9ef">)</span> -i ~/Downloads/ssh-key-for-us-east-1.pem -- cat /var/log/cloud-init-output.log
</span></span></code></pre></div><ol start="2">
<li>Check that <code>kubelet</code> has started successfully.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ ssh ubuntu@<span style="color:#66d9ef">$(</span>terraform output master_dns<span style="color:#66d9ef">)</span> -i ~/Downloads/ssh-key-for-us-east-1.pem -- systemctl status kubelet
</span></span></code></pre></div><ol start="3">
<li>Finally, ask to Kubernetes to show all Cluster Nodes and its status.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ ssh ubuntu@<span style="color:#66d9ef">$(</span>terraform output master_dns<span style="color:#66d9ef">)</span> -i ~/Downloads/ssh-key-for-us-east-1.pem -- kubectl get nodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                           STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>ip-10-0-100-154.ec2.internal   Ready    &lt;none&gt;   48m   v1.14.3
</span></span><span style="display:flex;"><span>ip-10-0-100-4.ec2.internal     Ready    master   49m   v1.14.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chilcano@inti:~/git-repos/affordable-k8s-tf$ ssh ubuntu@<span style="color:#66d9ef">$(</span>terraform output master_dns<span style="color:#66d9ef">)</span> -i ~/Downloads/ssh-key-for-us-east-1.pem -- kubectl cluster-info
</span></span><span style="display:flex;"><span>Kubernetes master is running at https://10.0.100.4:6443
</span></span><span style="display:flex;"><span>KubeDNS is running at https://10.0.100.4:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span></code></pre></div><p><img src="/assets/img/20200116-service-mesh-03-affordable-k8s-aws.png" alt="Affordable K8s Data Plane hosted in AWS" title="Affordable K8s Data Plane hosted in AWS"></p>
<p>If you want a cheap K8s Infrastructure on AWS, I recommend to use this GitHub repo I&rsquo;ve updated for you, once cloned just follow the above steps.
<a href="https://github.com/chilcano/kubeadm-aws/tree/0.2.1-chilcano">https://github.com/chilcano/kubeadm-aws/tree/0.2.1-chilcano</a></p>
<p>Below I&rsquo;ve selected a set of good references to read related to this article and that will surely interest you.
I hope this helps.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.doxsey.net/blog/kubernetes--the-surprisingly-affordable-platform-for-personal-projects">Kubernetes: The Surprisingly Affordable Platform for Personal Projects</a> By Caleb Doxsey - Sep 30, 2018</li>
<li><a href="https://devonblog.com/containers/affordable-kubernetes-cluster/">Affordable Kubernetes Cluster</a> By Remko Seelig - March 12, 2019</li>
<li><a href="https://github.com/hobby-kube/guide">Kubernetes clusters for the hobbyist</a> By Patrick Stadler - Latest commit on Oct 11, 2019</li>
<li><a href="https://software.danielwatrous.com/kubernetes-on-the-cheap/">Kubernetes on the cheap</a> By Daniel Watrous - Feb 9, 2019</li>
<li><a href="https://itsilesia.com/kubernetes-for-poor-how-to-run-your-cluster-and-not-go-bankrupt/">Kubernetes for poor - How to run your cluster and not go bankrupt</a> By Aleksander Grzybowski - Nov 13, 2018</li>
<li><a href="https://mehdi.me/running-a-personal-kubernetes-cluster-for-almost-from-on-gke/">Diary of a GKE Journeyman - Running your personal Kubernetes Cluster for (almost) free on GKE</a> By Mehdi El Gueddari - Mar 22, 2019</li>
<li><a href="https://github.com/awslabs/ec2-spot-labs">Collection of tools and code examples to demonstrate best practices in using Amazon EC2 Spot Instances.</a></li>
<li><a href="https://aws.amazon.com/ec2/spot/instance-advisor">AWS Spot Instance Advisor</a></li>
</ul>
<h3 id="kubernetes-distributions">Kubernetes&rsquo; distributions</h3>
<ul>
<li><a href="https://microk8s.io/">MicroK8s - Zero-ops Kubernetes for workstations and edge / IoT</a> By Ubuntu</li>
<li><a href="https://k3s.io/">K3s - Lightweight Kubernetes for IoT &amp; Edge computing</a> By Rancher</li>
<li><a href="https://github.com/kubernetes-sigs/kind">KinD - Kubernetes in Docker</a> By Kubernetes SIGs</li>
<li><a href="https://github.com/poseidon/typhoon">Typhoon - Minimal and free Kubernetes distribution</a> By poseidon</li>
</ul>
  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2022  Holistic Security 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/post">Blog</a></li>
         
        <li><a href="/taxonomy">Taxonomy</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-156433649-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
