<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Building an affordable remote DevOps desktop on AWS - Part2 (custom AMI with Packer) | Holistic Security</title>
  <meta name="description" content="With The Systems Thinking Methodology we are able to see any problem in a complete and holistic manner, in fact, The Systems Thinking Methodology allows us to solve complex problems (IT Security, Global Warming, World Poverty, etc.) by considering new factors, elements and variables (usability, trust, quality, risk, etc.) which were not considered initially.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Building an affordable remote DevOps desktop on AWS - Part2 (custom AMI with Packer)" />
<meta property="og:description" content="In the previous post Building an affordable remote DevOps desktop on AWS I shown you how to build a cheaper remote DevOps Desktop on AWS, now I&rsquo;ll explain you how to do that in approximately 3 minutes, instead of 25 minutes, using Hashicorp Packer to pre-bake an AWS AMI.
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://holisticsecurity.io/2020/04/20/building-an-affordable-remote-devops-desktop-on-aws-part2/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-04-20T10:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-04-20T10:00:00&#43;00:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building an affordable remote DevOps desktop on AWS - Part2 (custom AMI with Packer)"/>
<meta name="twitter:description" content="In the previous post Building an affordable remote DevOps desktop on AWS I shown you how to build a cheaper remote DevOps Desktop on AWS, now I&rsquo;ll explain you how to do that in approximately 3 minutes, instead of 25 minutes, using Hashicorp Packer to pre-bake an AWS AMI.
"/>

  
  
    
  
  
  <link rel="stylesheet" href="https://holisticsecurity.io/css/style-white.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://holisticsecurity.io/images/favicon.ico" />

  
  
  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-156433649-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
  
  

  <link rel="stylesheet" href="https://holisticsecurity.io/css/custom-cactus-style-white.css">
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://holisticsecurity.io/">
  
    <div id="logo" style="background-image: url(https://holisticsecurity.io/images/logo.png)"></div>
  
  <div id="title">
    <h1>Holistic Security</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/post">Blog</a></li>
      
        <li><a href="/taxonomy">Taxonomy</a></li>
      
        <li><a href="/about">About</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  
  <h1 class="posttitle" itemprop="name headline"> Building an affordable remote DevOps desktop on AWS - Part2 (custom AMI with Packer) </h1>

  <ul class="post-list">  
      <li class="post-item">
        <div class="meta">
          <time datetime="2020-04-20 10:00:00 &#43;0000 UTC" itemprop="datePublished">2020-04-20</time>
        </div>
        <span>    
          
          
          <div class="article-category">
              
              
              <a class="category-link" href="/categories/cloud">Cloud</a>
              
               · 
              <a class="category-link" href="/categories/devops">DevOps</a>
              
              · 
          </div>
          
          
          <div class="article-tag">
              
              
              <a class="tag-link" href="/tags/aws" rel="tag">AWS</a>
              
               · 
              <a class="tag-link" href="/tags/docker" rel="tag">Docker</a>
              
               · 
              <a class="tag-link" href="/tags/git" rel="tag">git</a>
              
               · 
              <a class="tag-link" href="/tags/vscode" rel="tag">VSCode</a>
              
               · 
              <a class="tag-link" href="/tags/terraform" rel="tag">Terraform</a>
              
               · 
              <a class="tag-link" href="/tags/packer" rel="tag">Packer</a>
              
          </div>
          
  
        </span>
      </li>  
    </ul>

  <div class="content" itemprop="articleBody">
  
    <p>In the previous post <a href="/2020/04/09/building-an-affordable-remote-devops-desktop-on-aws">Building an affordable remote DevOps desktop on AWS</a> I shown you how to build a cheaper remote DevOps Desktop on AWS, now I&rsquo;ll explain you how to do that in approximately 3 minutes, instead of 25 minutes, using <a href="https://www.packer.io">Hashicorp Packer</a> to pre-bake an AWS AMI.</p>
<p><a href="https://raw.githubusercontent.com/chilcano/affordable-remote-desktop/master/imgs/remote-devops-desktop-x2go-client-1-arch-packer.png"><img src="https://raw.githubusercontent.com/chilcano/affordable-remote-desktop/master/imgs/remote-devops-desktop-x2go-client-1-arch-packer.png" alt=""></a></p>
<p>By default, this article uses Terraform and Packer to provision a cheap AWS EC2 Spot instance. The approximate cost will be less of 10 euros/month for a <code>m1.small</code> instance located in <code>us-east-1</code> region. Also I share the <a href="https://github.com/chilcano/affordable-remote-desktop">GitHub repository with all Terraform and Packer scripts</a> where you will be able to change the configuration.</p>
<h2 id="getting-started">Getting started</h2>
<h3 id="1-clone-this-repository">1. Clone this repository</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ git clone https://github.com/chilcano/affordable-remote-desktop
$ cd affordable-remote-desktop
</code></pre></div><h3 id="2-execute-terraform-plan-using-customized-ami-by-default">2. Execute Terraform plan using customized AMI (by default)</h3>
<p>This process uses my customized public AMI (Name <code>chilcano/images/hvm-instance/ubuntu-bionic-18.04-amd64-gui</code> and Owner <code>Chilcano</code>). This customized AMI with <code>XFCE4</code> and <code>X2Go Server</code> pre-installed has been created using Hashicorp Packer.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ terraform init

$ terraform plan <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var node_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;devops1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ssh_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;remotedesktop&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var developer_cidr_blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.32.214.211/32&#34;</span> 

$ terraform apply <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var node_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;devops1&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ssh_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;remotedesktop&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var developer_cidr_blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.32.214.211/32&#34;</span> 
</code></pre></div><h3 id="3-execute-terraform-plan-providing-a-customized-ami-using-packerio">3. Execute Terraform plan providing a customized AMI (using Packer.io)</h3>
<p>The Terraform plan I share here detects if the base AMI used to build the EC2 Instance has <code>XFCE4</code> and <code>X2Go Server</code> pre-installed, if so Terraform will install both packages taking ~20 minutes more. In the below example, the Terraform plan execution will install both packages because the <code>ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server</code> AMI owned by <code>099720109477</code> (Ubuntu) doesn&rsquo;t include any GUI Desktop Environment installed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ terraform init

$ terraform plan <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var node_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;devops2&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ssh_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;remotedesktop&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var developer_cidr_blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.32.214.211/32&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ami_name_filter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*&#34;</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ami_owner<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;099720109477&#34;</span> 

$ terraform apply <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var node_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;devops2&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ssh_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;remotedesktop&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var developer_cidr_blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.32.214.211/32&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ami_name_filter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*&#34;</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ami_owner<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;099720109477&#34;</span> 
</code></pre></div><h4 id="31-crerating-a-custom-ami-with-packer">3.1. Crerating a custom AMI with Packer</h4>
<p>Finally, if you don&rsquo;t have any customized AMI with <code>XFCE4</code> and <code>X2Go Server</code> pre-installed, and you want one but <code>private</code>, then you are lucky because <a href="https://github.com/chilcano/affordable-remote-desktop/tree/master/resources/packer">I&rsquo;ve shared Packer scripts to cook your own</a>. Then the steps are:</p>
<ol>
<li>Install and configure Packer.</li>
<li>Download Packer (<code>ubuntu_gui.json</code>) script.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cd affordable-remote-desktop/resources/packer
$ export AWS_ACCESS_KEY_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your-access-key-id&#34;</span>; export AWS_SECRET_ACCESS_KEY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your-secret-access-key&#34;</span>
$ export AWS_VPC_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your-vpc-id-07c2fc78af4aca574&#34;</span>; export AWS_SUBNET_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your-subnet-id-00096b5a3329dd4b2&#34;</span> 

$ packer validate ubuntu_gui.json
$ packer build ubuntu_gui.json
</code></pre></div><ol start="3">
<li>Once created the custom AMI, you are able to provision your Remote DevOps Desktop on AWS using Terraform.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ terraform init

$ terraform plan <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var node_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;devops2&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ssh_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;remotedesktop&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var developer_cidr_blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.32.214.211/32&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ami_name_filter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your-ami-name-filter&#34;</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ami_owner<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your-ami-owner&#34;</span> 

$ terraform apply <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var node_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;devops2&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ssh_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;remotedesktop&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var developer_cidr_blocks<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;83.32.214.211/32&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ami_name_filter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your-ami-name-filter&#34;</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -var ami_owner<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your-ami-owner&#34;</span> 
</code></pre></div><h3 id="4-verifying-the-process">4. Verifying the process</h3>
<h4 id="41-check-the-ami-and-snapshot-created">4.1. Check the AMI and Snapshot created</h4>
<p><a href="https://raw.githubusercontent.com/chilcano/affordable-remote-desktop/master/resources/packer/imgs/packer-ubuntu-ami-gui-2-create-default-vpc.png"><img src="https://raw.githubusercontent.com/chilcano/affordable-remote-desktop/master/resources/packer/imgs/packer-ubuntu-ami-gui-1-create-default-vpc.png" alt=""></a></p>
<p><a href="https://raw.githubusercontent.com/chilcano/affordable-remote-desktop/master/resources/packer/imgs/packer-ubuntu-ami-gui-4-ec2-ami.png"><img src="https://raw.githubusercontent.com/chilcano/affordable-remote-desktop/master/resources/packer/imgs/packer-ubuntu-ami-gui-3-snapshot-ebs.png" alt=""></a></p>
<h4 id="42-check-the-ec2-instance-created">4.2. Check the EC2 Instance created</h4>
<p>After a few minutes, connect to EC2 instance created above.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$  terraform output remotedesktop_fqdn
ec2-54-160-183-171.compute-1.amazonaws.com

$ ssh ubuntu@<span style="color:#66d9ef">$(</span>terraform output remotedesktop_fqdn<span style="color:#66d9ef">)</span> -i ~/.ssh/remotedevenv

// Checking Cloud-Init 
ubuntu@ip-10-0-100-4:~$ tail -f /var/log/cloud-init-output.log

// Checking the bash scripts created by Cloud-Init
ubuntu@ip-10-0-100-4:~$ ls -la /var/lib/cloud/instance/scripts/
total <span style="color:#ae81ff">16</span>
drwxr-xr-x <span style="color:#ae81ff">2</span> root root <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">15</span> 18:28 .
drwxr-xr-x <span style="color:#ae81ff">5</span> root root <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">15</span> 18:35 ..
-rwx------ <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">2651</span> Apr <span style="color:#ae81ff">15</span> 18:28 install_devops.sh
-rwx------ <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">1149</span> Apr <span style="color:#ae81ff">15</span> 18:28 install_gui.sh
</code></pre></div><p>The <code>install_devops.sh</code> and <code>install_gui.sh</code> were created by Terraform during provisioning, both bash scripts install and configure the DevOps tools and GUI tools respectively.</p>
<h3 id="5-further-information">5. Further information</h3>
<ul>
<li><a href="https://github.com/chilcano/affordable-remote-desktop/tree/master/resources/packer">Creating an Ubuntu-based AMI with minimum GUI based on XFCE4 and X2Go</a></li>
</ul>
  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2022  Holistic Security 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/post">Blog</a></li>
         
        <li><a href="/taxonomy">Taxonomy</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-156433649-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
